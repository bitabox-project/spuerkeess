{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Faire un Virement</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <link
      rel="stylesheet"
      href="{% static 'sweetalert2/dist/sweetalert2.min.css' %}"
    />
    <script src="{% static 'sweetalert2/dist/sweetalert2.min.js' %}"></script>

    <style>
      body {
        background: #f8f9fa;
      }
      .navbar {
        background-color: #003060;
      }
      .navbar-brand img {
        height: 40px;
        margin-right: 10px;
      }
      .navbar-brand span {
        font-weight: bold;
        color: #fff;
        font-size: 1.2rem;
      }
      .promo-text {
        color: #ffcc00;
        font-weight: 500;
        font-size: 0.95rem;
      }
      .dropdown-toggle {
        color: #fff !important;
      }
      .card {
        border: none;
        border-radius: 10px;
      }
      .card-header {
        display: flex;
        align-items: center;
      }
      .card-header img {
        height: 40px;
        margin-right: 15px;
      }
      .form-label {
        font-weight: 500;
      }
      .btn-primary {
        background-color: #003060;
        border: none;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <!-- NAVBAR MODERNE -->
    <nav class="navbar">
      <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand text-white" href="{% url 'Mon_compte' %}">
          <img
            src="{% static 'favicons/kirabank20.png' %}"
            alt="KIRA logo"
            width="120"
            height="120"
          />

          Kyras
        </a>
        <div class="text-center d-none d-md-block">
          <span class="text-white fw-semibold" style="font-size: 2rem">
            üéâ <strong>80‚Ç¨ offerts</strong> en parrainant un proche ‚ù§Ô∏è‚Äçüî• &nbsp;
          </span>
          <p class="text-white fw-semibold">
            Profitez-en jusqu'au <strong>30 septembre 2025</strong> !
          </p>
        </div>
        <div></div>
        <!-- Espace √† droite pour √©quilibrer -->
      </div>
    </nav>

    <!-- FORMULAIRE VIREMENT -->
    <div class="container my-5">
      <div class="card shadow">
        <div class="card-header">
          <img src="{% static 'favicons/kirabank20.png' %}" alt="Logo Kyras" />
          <h5 class="mb-0">Faire un Virement</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Compte de d√©bit</label>
              <select
                name="compte_debit"
                id="compte_debit"
                class="form-select"
                required
              >
                {% for compte in comptes %}
                <option value="{{ compte.id }}" data-solde="{{ compte.solde }}">
                  {{ compte.description }} ‚Äî Solde:
                  {{compte.solde|floatformat:2}} {{ compte.devise }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Nom du b√©n√©ficiaire</label>
              <input
                type="text"
                name="nom_beneficiaire"
                class="form-control"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Banque du b√©n√©ficiaire</label>
              <input
                type="text"
                name="banque_beneficiaire"
                class="form-control"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">IBAN</label>
              <input type="text" name="iban" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label">BIC</label>
              <input type="text" name="bic" class="form-control" required />
            </div>

            <div class="mb-4">
              <label class="form-label">Montant</label>
              <input
                type="number"
                name="montant"
                step="0.01"
                class="form-control form-control-lg border-primary"
                required
                placeholder="0.00"
              />
            </div>

            <button
              type="button"
              id="btn-virement"
              class="btn btn-primary btn-lg w-100"
            >
              <i class="bi bi-arrow-right-circle me-1"></i> Valider le Virement
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document
        .getElementById("btn-virement")
        .addEventListener("click", function () {
          const montant = parseFloat(
            document.querySelector('input[name="montant"]').value
          );
          const compteSelect = document.getElementById("compte_debit");
          const solde = parseFloat(
            compteSelect.options[compteSelect.selectedIndex].dataset.solde
          );

          const nom = document
            .querySelector('input[name="nom_beneficiaire"]')
            .value.trim();
          const banque = document
            .querySelector('input[name="banque_beneficiaire"]')
            .value.trim();
          const iban = document
            .querySelector('input[name="iban"]')
            .value.trim();
          const bic = document.querySelector('input[name="bic"]').value.trim();

          // V√©rifier si tous les champs obligatoires sont remplis
          if (!nom || !banque || !iban || !bic) {
            Swal.fire({
              icon: "error",
              title: "Champs obligatoires",
              text: "Veuillez remplir correctement tous les champs.",
            });
            return;
          }

          // V√©rification du montant
          if (!montant || montant <= 0) {
            Swal.fire({
              icon: "error",
              title: "Montant invalide",
              text: "Veuillez saisir un montant sup√©rieur √† 0.",
            });
            return;
          }

          // V√©rification du solde
          if (montant > solde) {
            Swal.fire({
              icon: "warning",
              title: "Solde insuffisant",
              html: `Le solde de ce compte est de <strong>${solde.toFixed(
                2
              )} ‚Ç¨</strong>.<br>Le montant entr√© d√©passe ce solde.`,
            });
            return;
          }

          // Si tout est bon, afficher confirmation
          Swal.fire({
            title: "Confirmation",
            html: `Votre virement de <strong>${montant.toFixed(
              2
            )} ‚Ç¨</strong> a √©t√© pris en compte.`,
            icon: "success",
            confirmButtonColor: "#003060",
            confirmButtonText: "OK",
          }).then((result) => {
            if (result.isConfirmed) {
              document.querySelector("form").submit();
            }
          });
        });
    </script>
  </body>
</html>
